'use client';

import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';

interface CIEPoint {
    x: number;
    y: number;
    label?: string;
    color?: string;
    type: 'reference' | 'measured';
    status?: 'pass' | 'fail' | 'soft-fail';
}

interface CIEPlotProps {
    primaries?: {
        red: { x: number; y: number };
        green: { x: number; y: number };
        blue: { x: number; y: number };
        white: { x: number; y: number };
    }; // Reference Gamut
    measuredPrimaries?: {
        red?: { x: number; y: number };
        green?: { x: number; y: number };
        blue?: { x: number; y: number };
        white?: { x: number; y: number };
    };
    points?: CIEPoint[]; // Additional points (e.g. for Color Accuracy)
    title?: string;
}

// Simplified Spectral Locus Data (Approximate for visual reference)
// In a real app, we'd use a high-res path.
const SPECTRAL_LOCUS = [
    { x: 0.175596, y: 0.005295 }, { x: 0.172787, y: 0.004800 }, { x: 0.170342, y: 0.004352 },
    { x: 0.168236, y: 0.003950 }, { x: 0.166427, y: 0.003591 }, { x: 0.164864, y: 0.003274 },
    { x: 0.163502, y: 0.002997 }, { x: 0.162304, y: 0.002758 }, { x: 0.161241, y: 0.002554 },
    { x: 0.160289, y: 0.002382 }, { x: 0.159431, y: 0.002239 }, { x: 0.158648, y: 0.002122 },
    { x: 0.157928, y: 0.002029 }, { x: 0.157259, y: 0.001958 }, { x: 0.156633, y: 0.001906 },
    { x: 0.156043, y: 0.001872 }, { x: 0.155484, y: 0.001853 }, { x: 0.154950, y: 0.001848 },
    { x: 0.154436, y: 0.001856 }, { x: 0.153939, y: 0.001875 }, { x: 0.153456, y: 0.001905 },
    { x: 0.152983, y: 0.001946 }, { x: 0.152520, y: 0.001998 }, { x: 0.152064, y: 0.002060 },
    { x: 0.151614, y: 0.002132 }, { x: 0.151169, y: 0.002215 }, { x: 0.150726, y: 0.002308 },
    { x: 0.150286, y: 0.002412 }, { x: 0.149846, y: 0.002526 }, { x: 0.149408, y: 0.002650 },
    { x: 0.148969, y: 0.002785 }, { x: 0.148530, y: 0.002931 }, { x: 0.148089, y: 0.003088 },
    { x: 0.147646, y: 0.003256 }, { x: 0.147202, y: 0.003436 }, { x: 0.146755, y: 0.003628 },
    { x: 0.146305, y: 0.003831 }, { x: 0.145852, y: 0.004046 }, { x: 0.145397, y: 0.004273 },
    { x: 0.144938, y: 0.004512 }, { x: 0.144475, y: 0.004762 }, { x: 0.144009, y: 0.005024 },
    { x: 0.143539, y: 0.005298 }, { x: 0.143065, y: 0.005583 }, { x: 0.142587, y: 0.005879 },
    { x: 0.142106, y: 0.006186 }, { x: 0.141620, y: 0.006503 }, { x: 0.141130, y: 0.006831 },
    { x: 0.140636, y: 0.007170 }, { x: 0.140138, y: 0.007518 }, { x: 0.139636, y: 0.007876 },
    { x: 0.139130, y: 0.008245 }, { x: 0.138620, y: 0.008623 }, { x: 0.138106, y: 0.009011 },
    { x: 0.137588, y: 0.009409 }, { x: 0.137066, y: 0.009816 }, { x: 0.136540, y: 0.010232 },
    { x: 0.136011, y: 0.010657 }, { x: 0.135478, y: 0.011091 }, { x: 0.134942, y: 0.011533 },
    { x: 0.134402, y: 0.011985 }, { x: 0.133859, y: 0.012445 }, { x: 0.133313, y: 0.012914 },
    { x: 0.132764, y: 0.013392 }, { x: 0.132212, y: 0.013878 }, { x: 0.131657, y: 0.014374 },
    { x: 0.131100, y: 0.014878 }, { x: 0.130540, y: 0.015391 }, { x: 0.129978, y: 0.015913 },
    { x: 0.129414, y: 0.016444 }, { x: 0.128848, y: 0.016984 }, { x: 0.128281, y: 0.017533 },
    { x: 0.127712, y: 0.018091 }, { x: 0.127142, y: 0.018658 }, { x: 0.126571, y: 0.019235 },
    { x: 0.125999, y: 0.019821 }, { x: 0.125426, y: 0.020417 }, { x: 0.124853, y: 0.021023 },
    { x: 0.124280, y: 0.021639 }, { x: 0.123706, y: 0.022265 }, { x: 0.123132, y: 0.022901 },
    { x: 0.122558, y: 0.023547 }, { x: 0.121984, y: 0.024203 }, { x: 0.121409, y: 0.024869 },
    { x: 0.120835, y: 0.025546 }, { x: 0.120261, y: 0.026234 }, { x: 0.119688, y: 0.026932 },
    { x: 0.119114, y: 0.027641 }, { x: 0.118541, y: 0.028361 }, { x: 0.117969, y: 0.029093 },
    { x: 0.117397, y: 0.029835 }, { x: 0.116825, y: 0.030589 }, { x: 0.116254, y: 0.031355 },
    { x: 0.115684, y: 0.032132 }, { x: 0.115115, y: 0.032921 }, { x: 0.114547, y: 0.033723 },
    { x: 0.113980, y: 0.034536 }, { x: 0.113414, y: 0.035362 }, { x: 0.112849, y: 0.036200 },
    { x: 0.112286, y: 0.037051 }, { x: 0.111723, y: 0.037915 }, { x: 0.111161, y: 0.038791 },
    { x: 0.110601, y: 0.039681 }, { x: 0.110042, y: 0.040584 }, { x: 0.109484, y: 0.041500 },
    { x: 0.108928, y: 0.042430 }, { x: 0.108373, y: 0.043373 }, { x: 0.107819, y: 0.044330 },
    { x: 0.107267, y: 0.045301 }, { x: 0.106716, y: 0.046286 }, { x: 0.106167, y: 0.047286 },
    { x: 0.105619, y: 0.048300 }, { x: 0.105073, y: 0.049329 }, { x: 0.104529, y: 0.050373 },
    { x: 0.103986, y: 0.051432 }, { x: 0.103446, y: 0.052507 }, { x: 0.102907, y: 0.053598 },
    { x: 0.102370, y: 0.054704 }, { x: 0.101835, y: 0.055826 }, { x: 0.101302, y: 0.056965 },
    { x: 0.100771, y: 0.058120 }, { x: 0.100242, y: 0.059292 }, { x: 0.099715, y: 0.060481 },
    { x: 0.099190, y: 0.061687 }, { x: 0.098667, y: 0.062910 }, { x: 0.098146, y: 0.064150 },
    { x: 0.097627, y: 0.065409 }, { x: 0.097110, y: 0.066685 }, { x: 0.096595, y: 0.067979 },
    { x: 0.096083, y: 0.069292 }, { x: 0.095573, y: 0.070623 }, { x: 0.095065, y: 0.071973 },
    { x: 0.094559, y: 0.073342 }, { x: 0.094056, y: 0.074730 }, { x: 0.093555, y: 0.076137 },
    { x: 0.093056, y: 0.077564 }, { x: 0.092559, y: 0.079010 }, { x: 0.092065, y: 0.080477 },
    { x: 0.091573, y: 0.081963 }, { x: 0.091083, y: 0.083470 }, { x: 0.090596, y: 0.084997 },
    { x: 0.090111, y: 0.086545 }, { x: 0.089629, y: 0.088114 }, { x: 0.089149, y: 0.089704 },
    { x: 0.088672, y: 0.091315 }, { x: 0.088197, y: 0.092948 }, { x: 0.087725, y: 0.094603 },
    { x: 0.087256, y: 0.096280 }, { x: 0.086789, y: 0.097979 }, { x: 0.086325, y: 0.099700 },
    { x: 0.085864, y: 0.101444 }, { x: 0.085405, y: 0.103211 }, { x: 0.084949, y: 0.105001 },
    { x: 0.084496, y: 0.106814 }, { x: 0.084046, y: 0.108651 }, { x: 0.083598, y: 0.110512 },
    { x: 0.083153, y: 0.112396 }, { x: 0.082711, y: 0.114305 }, { x: 0.082272, y: 0.116238 },
    { x: 0.081836, y: 0.118196 }, { x: 0.081403, y: 0.120179 }, { x: 0.080973, y: 0.122187 },
    { x: 0.080545, y: 0.124221 }, { x: 0.080121, y: 0.126281 }, { x: 0.079699, y: 0.128366 },
    { x: 0.079281, y: 0.130477 }, { x: 0.078866, y: 0.132615 }, { x: 0.078453, y: 0.134779 },
    { x: 0.078044, y: 0.136970 }, { x: 0.077638, y: 0.139188 }, { x: 0.077235, y: 0.141433 },
    { x: 0.076835, y: 0.143706 }, { x: 0.076439, y: 0.146007 }, { x: 0.076046, y: 0.148335 },
    { x: 0.075656, y: 0.150691 }, { x: 0.075269, y: 0.153075 }, { x: 0.074886, y: 0.155488 },
    { x: 0.074506, y: 0.157929 }, { x: 0.074129, y: 0.160399 }, { x: 0.073756, y: 0.162898 },
    { x: 0.073387, y: 0.165426 }, { x: 0.073020, y: 0.167983 }, { x: 0.072658, y: 0.170570 },
    { x: 0.072299, y: 0.173186 }, { x: 0.071943, y: 0.175833 }, { x: 0.071591, y: 0.178509 },
    { x: 0.071243, y: 0.181216 }, { x: 0.070898, y: 0.183953 }, { x: 0.070557, y: 0.186721 },
    { x: 0.070220, y: 0.189519 }, { x: 0.069886, y: 0.192348 }, { x: 0.069556, y: 0.195208 },
    { x: 0.069229, y: 0.198099 }, { x: 0.068906, y: 0.201021 }, { x: 0.068587, y: 0.203975 },
    { x: 0.068272, y: 0.206960 }, { x: 0.067960, y: 0.209977 }, { x: 0.067653, y: 0.213025 },
    { x: 0.067349, y: 0.216106 }, { x: 0.067049, y: 0.219218 }, { x: 0.066753, y: 0.222363 },
    { x: 0.066461, y: 0.225540 }, { x: 0.066173, y: 0.228749 }, { x: 0.065889, y: 0.231990 },
    { x: 0.065609, y: 0.235264 }, { x: 0.065333, y: 0.238570 }, { x: 0.065061, y: 0.241908 },
    { x: 0.064794, y: 0.245279 }, { x: 0.064530, y: 0.248683 }, { x: 0.064271, y: 0.252119 },
    { x: 0.064016, y: 0.255588 }, { x: 0.063766, y: 0.259090 }, { x: 0.063519, y: 0.262625 },
    { x: 0.063277, y: 0.266193 }, { x: 0.063039, y: 0.269794 }, { x: 0.062806, y: 0.273428 },
    { x: 0.062577, y: 0.277096 }, { x: 0.062352, y: 0.280797 }, { x: 0.062132, y: 0.284531 },
    { x: 0.061916, y: 0.288299 }, { x: 0.061705, y: 0.292100 }, { x: 0.061498, y: 0.295934 },
    { x: 0.061296, y: 0.299801 }, { x: 0.061098, y: 0.303702 }, { x: 0.060905, y: 0.307637 },
    { x: 0.060716, y: 0.311606 }, { x: 0.060532, y: 0.315608 }, { x: 0.060353, y: 0.319644 },
    { x: 0.060178, y: 0.323714 }, { x: 0.060008, y: 0.327818 }, { x: 0.059842, y: 0.331956 },
    { x: 0.059682, y: 0.336128 }, { x: 0.059526, y: 0.340334 }, { x: 0.059375, y: 0.344575 },
    { x: 0.059228, y: 0.348849 }, { x: 0.059086, y: 0.353158 }, { x: 0.058949, y: 0.357501 },
    { x: 0.058817, y: 0.361879 }, { x: 0.058689, y: 0.366291 }, { x: 0.058566, y: 0.370738 },
    { x: 0.058448, y: 0.375218 }, { x: 0.058335, y: 0.379733 }, { x: 0.058227, y: 0.384282 },
    { x: 0.058124, y: 0.388865 }, { x: 0.058026, y: 0.393482 }, { x: 0.057933, y: 0.398134 },
    { x: 0.057845, y: 0.402820 }, { x: 0.057762, y: 0.407540 }, { x: 0.057684, y: 0.412293 },
    { x: 0.057611, y: 0.417081 }, { x: 0.057543, y: 0.421902 }, { x: 0.057480, y: 0.426757 },
    { x: 0.057422, y: 0.431646 }, { x: 0.057369, y: 0.436568 }, { x: 0.057321, y: 0.441524 },
    { x: 0.057278, y: 0.446513 }, { x: 0.057240, y: 0.451535 }, { x: 0.057207, y: 0.456590 },
    { x: 0.057179, y: 0.461678 }, { x: 0.057156, y: 0.466799 }, { x: 0.057138, y: 0.471953 },
    { x: 0.057125, y: 0.477139 }, { x: 0.057117, y: 0.482358 }, { x: 0.057114, y: 0.487610 },
    { x: 0.057117, y: 0.492893 }, { x: 0.057125, y: 0.498209 }, { x: 0.057138, y: 0.503557 },
    { x: 0.057157, y: 0.508937 }, { x: 0.057182, y: 0.514348 }, { x: 0.057212, y: 0.519791 },
    { x: 0.057248, y: 0.525265 }, { x: 0.057289, y: 0.530771 }, { x: 0.057336, y: 0.536308 },
    { x: 0.057389, y: 0.541876 }, { x: 0.057448, y: 0.547475 }, { x: 0.057513, y: 0.553106 },
    { x: 0.057584, y: 0.558767 }, { x: 0.057661, y: 0.564459 }, { x: 0.057745, y: 0.570182 },
    { x: 0.057835, y: 0.575935 }, { x: 0.057931, y: 0.581719 }, { x: 0.058034, y: 0.587533 },
    { x: 0.058144, y: 0.593378 }, { x: 0.058260, y: 0.599253 }, { x: 0.058383, y: 0.605158 },
    { x: 0.058513, y: 0.611093 }, { x: 0.058650, y: 0.617059 }, { x: 0.058794, y: 0.623055 },
    { x: 0.058945, y: 0.629080 }, { x: 0.059103, y: 0.635136 }, { x: 0.059268, y: 0.641221 },
    { x: 0.059441, y: 0.647337 }, { x: 0.059620, y: 0.653483 }, { x: 0.059807, y: 0.659658 },
    { x: 0.060001, y: 0.665863 }, { x: 0.060203, y: 0.672098 }, { x: 0.060413, y: 0.678362 },
    { x: 0.060630, y: 0.684656 }, { x: 0.060855, y: 0.690979 }, { x: 0.061088, y: 0.697332 },
    { x: 0.061329, y: 0.703714 }, { x: 0.061578, y: 0.710126 }, { x: 0.061835, y: 0.716567 },
    { x: 0.062100, y: 0.723037 }, { x: 0.062373, y: 0.729537 }, { x: 0.062655, y: 0.736066 },
    { x: 0.062945, y: 0.742624 }, { x: 0.063244, y: 0.749211 }, { x: 0.063551, y: 0.755828 },
    { x: 0.063867, y: 0.762473 }, { x: 0.064192, y: 0.769148 }, { x: 0.064526, y: 0.775851 },
    { x: 0.064869, y: 0.782584 }, { x: 0.065221, y: 0.789346 }, { x: 0.065583, y: 0.796136 },
    { x: 0.065954, y: 0.802955 }, { x: 0.066334, y: 0.809803 }, { x: 0.066724, y: 0.816679 },
    { x: 0.067124, y: 0.823584 }, { x: 0.067533, y: 0.830518 }, { x: 0.067952, y: 0.837480 },
    { x: 0.068381, y: 0.844471 }, { x: 0.068820, y: 0.851491 }, { x: 0.069269, y: 0.858539 },
    { x: 0.069728, y: 0.865615 }, { x: 0.070197, y: 0.872720 }, { x: 0.070677, y: 0.879852 },
    { x: 0.071168, y: 0.887013 }, { x: 0.071669, y: 0.894202 }, { x: 0.072181, y: 0.901418 },
    { x: 0.072704, y: 0.908663 }, { x: 0.073238, y: 0.915936 }, { x: 0.073784, y: 0.923236 },
    { x: 0.074341, y: 0.930565 }, { x: 0.074911, y: 0.937921 }, { x: 0.075492, y: 0.945305 },
    { x: 0.076085, y: 0.952717 }, { x: 0.076691, y: 0.960156 }, { x: 0.077309, y: 0.967622 },
    { x: 0.077940, y: 0.975116 }, { x: 0.078584, y: 0.982637 }, { x: 0.079241, y: 0.990185 },
    { x: 0.079911, y: 0.997760 }, { x: 0.175596, y: 0.005295 } // Close loop
];

export function CIEPlot({ primaries, measuredPrimaries, points, title }: CIEPlotProps) {
    // Coordinate System: x [0, 0.8], y [0, 0.9]
    // SVG ViewBox: 0 0 800 900
    // Mapping: x -> x * 1000, y -> (0.9 - y) * 1000 (Flip Y)

    const mapX = (x: number) => (x / 0.8) * 800;
    const mapY = (y: number) => (1 - (y / 0.9)) * 900;

    const spectralPath = SPECTRAL_LOCUS.map((p, i) =>
        `${i === 0 ? 'M' : 'L'} ${mapX(p.x)} ${mapY(p.y)}`
    ).join(' ') + ' Z';

    // Gamut Triangle
    let gamutPath = '';
    if (primaries) {
        gamutPath = `M ${mapX(primaries.red.x)} ${mapY(primaries.red.y)} ` +
            `L ${mapX(primaries.green.x)} ${mapY(primaries.green.y)} ` +
            `L ${mapX(primaries.blue.x)} ${mapY(primaries.blue.y)} Z`;
    }

    // Measured Gamut Triangle
    let measuredGamutPath = '';
    if (measuredPrimaries && measuredPrimaries.red && measuredPrimaries.green && measuredPrimaries.blue) {
        measuredGamutPath = `M ${mapX(measuredPrimaries.red.x)} ${mapY(measuredPrimaries.red.y)} ` +
            `L ${mapX(measuredPrimaries.green.x)} ${mapY(measuredPrimaries.green.y)} ` +
            `L ${mapX(measuredPrimaries.blue.x)} ${mapY(measuredPrimaries.blue.y)} Z`;
    }

    return (
        <Card className="w-full max-w-[500px] mx-auto">
            <CardHeader className="pb-2">
                <CardTitle className="text-base">{title || "CIE 1931 Chromaticity Diagram"}</CardTitle>
            </CardHeader>
            <CardContent>
                <div className="relative w-full pt-[100%]">
                    <svg
                        viewBox="0 0 800 900"
                        className="absolute top-0 left-0 w-full h-full bg-slate-50 dark:bg-slate-900 rounded-md border"
                    >
                        {/* Grid Lines (Optional) */}
                        <defs>
                            <pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse">
                                <path d="M 100 0 L 0 0 0 100" fill="none" stroke="gray" strokeWidth="0.5" opacity="0.2" />
                            </pattern>
                        </defs>
                        <rect width="800" height="900" fill="url(#grid)" />

                        {/* Spectral Locus */}
                        <path d={spectralPath} fill="none" stroke="currentColor" strokeWidth="2" className="text-slate-400" />

                        {/* Reference Gamut */}
                        {gamutPath && (
                            <path d={gamutPath} fill="none" stroke="#8884d8" strokeWidth="2" strokeDasharray="4 4" />
                        )}

                        {/* Measured Gamut */}
                        {measuredGamutPath && (
                            <path d={measuredGamutPath} fill="none" stroke="#ff7300" strokeWidth="2" />
                        )}

                        {/* Reference Points */}
                        {primaries && Object.entries(primaries).map(([key, p]) => (
                            <circle
                                key={`ref-${key}`}
                                cx={mapX(p.x)}
                                cy={mapY(p.y)}
                                r="6"
                                fill="none"
                                stroke="#8884d8"
                                strokeWidth="2"
                            />
                        ))}

                        {/* Measured Points */}
                        {measuredPrimaries && Object.entries(measuredPrimaries).map(([key, p]) => {
                            if (!p) return null;
                            return (
                                <circle
                                    key={`meas-${key}`}
                                    cx={mapX(p.x)}
                                    cy={mapY(p.y)}
                                    r="5"
                                    fill="#ff7300"
                                />
                            );
                        })}

                        {/* Additional Points */}
                        {points && points.map((p, i) => (
                            <TooltipProvider key={i}>
                                <Tooltip>
                                    <TooltipTrigger asChild>
                                        <circle
                                            cx={mapX(p.x)}
                                            cy={mapY(p.y)}
                                            r={p.type === 'reference' ? 6 : 4}
                                            fill={p.type === 'reference' ? 'none' : (p.color || '#ff7300')}
                                            stroke={p.type === 'reference' ? (p.color || '#8884d8') : 'none'}
                                            strokeWidth={2}
                                            className="cursor-pointer hover:r-8 transition-all"
                                        />
                                    </TooltipTrigger>
                                    <TooltipContent>
                                        <p>{p.label}</p>
                                        <p>x: {p.x.toFixed(4)}, y: {p.y.toFixed(4)}</p>
                                    </TooltipContent>
                                </Tooltip>
                            </TooltipProvider>
                        ))}
                    </svg>
                </div>
            </CardContent>
        </Card>
    );
}
